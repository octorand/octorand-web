<div class="container-fluid">
    <div class="content">
        <div class="row align-items-center">
            <div class="col-sm">
                <h1 class="content-title my-10">
                    Prediction
                </h1>
            </div>
            <div class="col-auto">
                <button class="btn mr-5" type="button" (click)="navigateToPage(gameDefinition.route)">
                    <i class="fas fa-arrow-left text-danger mr-5"></i>
                    Back
                </button>
                <button class="btn" type="button" (click)="loadGameDetails()">
                    <i class="fas fa-cog text-danger mr-5" [ngClass]="{'fa-spin': loading}"></i>
                    Refresh
                </button>
            </div>
        </div>
    </div>
    <div class="row row-eq-spacing-xl">
        <div *ngIf="actions.loadingGame" class="col-xl-6">
            <div class="card h-full">
                <div class="row">
                    <div class="col-sm">
                        <h2 class="content-title text-success">
                            Game details
                        </h2>
                        <p class="text-muted mb-20">
                            {{gameDefinition.description}}
                        </p>
                    </div>
                </div>
                <hr>
            </div>
        </div>
        <div *ngIf="!actions.loadingGame && loadingError" class="col-xl-6">
            <div class="card h-full">
                <div class="row">
                    <div class="col-sm">
                        <h2 class="content-title text-success">
                            Game details
                        </h2>
                        <p class="text-muted mb-20">
                            {{gameDefinition.description}}
                        </p>
                    </div>
                </div>
                <hr>
                <p class="text-danger mb-20">
                    We could not find the details of this game.
                </p>
                <button class="btn btn-success mb-5 mr-5" (click)="navigateToPage(gameDefinition.route)">
                    Browse Active Games
                </button>
            </div>
        </div>
        <div *ngIf="!actions.loadingGame && !loadingError" class="col-xl-6">
            <div class="card h-full">
                <div class="row">
                    <div class="col-sm">
                        <h2 class="content-title text-success">
                            Game details
                        </h2>
                        <p class="text-muted mb-20">
                            {{gameDefinition.description}}
                        </p>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-no-outer-padding">
                        <tbody>
                            <tr>
                                <td class="text-secondary">Name</td>
                                <td>{{gameDetails.storage.name}}</td>
                            </tr>
                            <tr>
                                <td class="text-secondary">Manager</td>
                                <td innerHTML="{{gameDetails.storage.manager | identity | async}}"></td>
                            </tr>
                            <tr>
                                <td class="text-secondary">Asset</td>
                                <td innerHTML="{{gameDetails.assetId | asset | async}}"></td>
                            </tr>
                            <tr>
                                <td class="text-secondary">Volume</td>
                                <td innerHTML="{{gameDetails.storage.volume | amount:gameDetails.assetId | async}}">
                                </td>
                            </tr>
                            <tr>
                                <td class="text-secondary">Status</td>
                                <td>{{gameDetails.status}}</td>
                            </tr>
                            <tr>
                                <td class="text-secondary">Timer</td>
                                <td>{{gameDetails.timespanLeft}}</td>
                            </tr>
                            <tr *ngIf="gameDetails.storage.winner > 0">
                                <td class="text-secondary">Result</td>
                                <td *ngIf="gameDetails.storage.winner == 1">
                                    {{gameDetails.storage.option1}}
                                </td>
                                <td *ngIf="gameDetails.storage.winner == 2">
                                    {{gameDetails.storage.option2}}
                                </td>
                                <td *ngIf="gameDetails.storage.winner == 3">
                                    {{gameDetails.storage.option3}}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div *ngIf="!actions.loadingGame && !loadingError" class="col-xl-6">
            <div class="card h-full">
                <div class="row">
                    <div class="col-sm">
                        <h2 class="content-title text-success">
                            Submit bets
                        </h2>
                        <p *ngIf="gameDetails.status == 'Running'" class="text-muted mb-20">
                            This game is currently active. Submit your bets by paying with
                            <span innerHTML="{{gameDetails.assetId | asset:false | async}}"></span>.
                            The odds of options will change with each bet. At the end of the game, players who bet on
                            the winning option will share the total prize pool propotional to their bet amounts.
                        </p>
                        <p *ngIf="gameDetails.status == 'Finalising'" class="text-muted mb-20">
                            This game is being finalised by its manager now. You can no longer submit bets for this
                            game. If you submit bets earlier, you will be able to see whether you have
                            won, once it is finalised.
                        </p>
                        <p *ngIf="gameDetails.status == 'Completed'" class="text-muted mb-20">
                            This game is finalised now. You can no longer submit bets for this game. If
                            you submit bets earlier, scroll down to see whether you have won.
                        </p>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-no-outer-padding">
                        <tbody>
                            <tr>
                                <td class="text-secondary"></td>
                                <td class="text-secondary">{{gameDetails.storage.option1}}</td>
                                <td class="text-secondary">{{gameDetails.storage.option2}}</td>
                                <td class="text-secondary" *ngIf="gameDetails.storage.option3">
                                    {{gameDetails.storage.option3}}</td>
                            </tr>
                            <tr>
                                <td class="text-secondary">Total bets</td>
                                <td innerHTML="{{gameDetails.storage.tickets1 | amount:gameDetails.assetId | async}}">
                                </td>
                                <td innerHTML="{{gameDetails.storage.tickets2 | amount:gameDetails.assetId | async}}">
                                </td>
                                <td *ngIf="gameDetails.storage.option3"
                                    innerHTML="{{gameDetails.storage.tickets3 | amount:gameDetails.assetId | async}}">
                                </td>
                            </tr>
                            <tr>
                                <td class="text-secondary">Your bets</td>
                                <td innerHTML="{{gameDetails.account.tickets1 | amount:gameDetails.assetId | async}}">
                                </td>
                                <td innerHTML="{{gameDetails.account.tickets2 | amount:gameDetails.assetId | async}}">
                                </td>
                                <td *ngIf="gameDetails.storage.option3"
                                    innerHTML="{{gameDetails.account.tickets3 | amount:gameDetails.assetId | async}}">
                                </td>
                            </tr>
                            <tr>
                                <td *ngIf="gameDetails.status == 'Running'" class="text-secondary">Current odds</td>
                                <td *ngIf="gameDetails.status != 'Running'" class="text-secondary">Final odds</td>
                                <td>{{gameDetails.odds1 | number: '1.2-2'}}x</td>
                                <td>{{gameDetails.odds2 | number: '1.2-2'}}x</td>
                                <td *ngIf="gameDetails.storage.option3">{{gameDetails.odds3 | number: '1.2-2'}}x</td>
                            </tr>
                            <tr *ngIf="gameDetails.status == 'Running'">
                                <td class="text-secondary">Place bets</td>
                                <td class="text-secondary">
                                    <input [(ngModel)]="model.amount1" class="form-control w-100 mw-full" type="number"
                                        placeholder="Amount">
                                    <button *ngIf="!actions.submittingBets1" class="btn btn-success w-100 mt-10 mb-0"
                                        (click)="submitBets(1)">
                                        Place Bet
                                    </button>
                                    <button *ngIf="actions.submittingBets1" class="btn btn-success w-100 mt-10 mb-0">
                                        <i class="fas fa-cog fa-spin mx-20"></i>
                                    </button>
                                </td>
                                <td class="text-secondary">
                                    <input [(ngModel)]="model.amount2" class="form-control w-100 mw-full" type="number"
                                        placeholder="Amount">
                                    <button *ngIf="!actions.submittingBets2" class="btn btn-success w-100 mt-10 mb-0"
                                        (click)="submitBets(2)">
                                        Place Bet
                                    </button>
                                    <button *ngIf="actions.submittingBets2" class="btn btn-success w-100 mt-10 mb-0">
                                        <i class="fas fa-cog fa-spin mx-20"></i>
                                    </button>
                                </td>
                                <td class="text-secondary" *ngIf="gameDetails.storage.option3">
                                    <input [(ngModel)]="model.amount3" class="form-control w-100 mw-full" type="number"
                                        placeholder="Amount">
                                    <button *ngIf="!actions.submittingBets3" class="btn btn-success w-100 mt-10 mb-0"
                                        (click)="submitBets(3)">
                                        Place Bet
                                    </button>
                                    <button *ngIf="actions.submittingBets3" class="btn btn-success w-100 mt-10 mb-0">
                                        <i class="fas fa-cog fa-spin mx-20"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="row row-eq-spacing-xl">
        <div *ngIf="!actions.loadingGame && !loadingError" class="col-xl-12">
            <div class="card h-full">
                <div class="row">
                    <div class="col-sm">
                        <h2 class="content-title text-success">
                            Payouts
                        </h2>
                        <p *ngIf="gameDetails.status == 'Running'" class="text-muted mb-20">
                            The <span innerHTML="{{gameDetails.assetId | asset:false | async}}"></span> spent by players
                            to submit bets is distributed between winners, game manager and our platform as below. As
                            more bets are placed, the payout amounts will increase accordingly.
                        </p>
                        <p *ngIf="gameDetails.status == 'Finalising'" class="text-muted mb-20">
                            The <span innerHTML="{{gameDetails.assetId | asset:false | async}}"></span> spent by players
                            to submit bets will be distributed between winners, game manager and our platform as below.
                        </p>
                        <p *ngIf="gameDetails.status == 'Completed'" class="text-muted mb-20">
                            The <span innerHTML="{{gameDetails.assetId | asset:false | async}}"></span> spent by players
                            to submit bets is distributed between winners, game manager and our platform as below.
                        </p>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-no-outer-padding">
                        <tbody>
                            <tr>
                                <td class="text-secondary">Payee</td>
                                <td class="text-secondary">Percentage</td>
                                <td class="text-secondary">Receiver</td>
                                <td class="text-secondary">Amount</td>
                            </tr>
                            <tr *ngFor="let payout of gameDetails.payouts">
                                <td>{{payout.payee}}</td>
                                <td>{{payout.percentage}}%</td>
                                <td *ngIf="payout.address" innerHTML="{{payout.address | identity | async}}"></td>
                                <td *ngIf="!payout.address">Multiple</td>
                                <td>
                                    <span innerHTML="{{payout.amount | amount:gameDetails.assetId | async}}"></span>
                                    <span *ngIf="payout.withdrawn" class="ml-10 hand" data-toggle="tooltip"
                                        data-title="Withdrawn">
                                        <i class="fas fa-check-circle text-success"></i>
                                    </span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div *ngIf="gameDetails.account.payout > 0">
                    <button *ngIf="!actions.withdrawingEarnings" class="btn btn-success mt-20 mb-0"
                        (click)="withdrawEarnings()">
                        Withdraw Earnings -
                        <span innerHTML="{{gameDetails.account.payout | amount:gameDetails.assetId | async}}"></span>
                    </button>
                    <button *ngIf="actions.withdrawingEarnings" class="btn btn-success mt-20 mb-0">
                        <i class="fas fa-cog fa-spin mx-20"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="row row-eq-spacing-xl">
        <div *ngIf="!actions.loadingGame && !loadingError" class="col-xl-12">
            <div class="card h-full">
                <div class="row">
                    <div class="col-sm">
                        <h2 class="content-title text-success">
                            Bets distribution
                        </h2>
                        <p *ngIf="gameDetails.status == 'Running'" class="text-muted mb-20">
                            Check out how the bets are placed by players at the moment. The higher the bet amount, the
                            higher the payout will be for winning players.
                        </p>
                        <p *ngIf="gameDetails.status == 'Finalising'" class="text-muted mb-20">
                            Check out how the bets are placed by players. The higher the bet amount, the
                            higher the payout will be for winning players.
                        </p>
                        <p *ngIf="gameDetails.status == 'Completed'" class="text-muted mb-20">
                            Check out how the bets are placed by players. The higher the bet amount, the
                            higher the payout is for winning players.
                        </p>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-no-outer-padding">
                        <tbody>
                            <tr>
                                <td class="text-secondary">Player</td>
                                <td class="text-secondary">
                                    {{gameDetails.storage.option1}}
                                    <span *ngIf="gameDetails.storage.winner == 1" class="ml-10 hand"
                                        data-toggle="tooltip" data-title="Winner">
                                        <i class="fas fa-medal text-success"></i>
                                    </span>
                                </td>
                                <td class="text-secondary">
                                    {{gameDetails.storage.option2}}
                                    <span *ngIf="gameDetails.storage.winner == 2" class="ml-10 hand"
                                        data-toggle="tooltip" data-title="Winner">
                                        <i class="fas fa-medal text-success"></i>
                                    </span>
                                </td>
                                <td class="text-secondary" *ngIf="gameDetails.storage.option3">
                                    {{gameDetails.storage.option3}}
                                    <span *ngIf="gameDetails.storage.winner == 3" class="ml-10 hand"
                                        data-toggle="tooltip" data-title="Winner">
                                        <i class="fas fa-medal text-success"></i>
                                    </span>
                                </td>
                                <td class="text-secondary" *ngIf="gameDetails.status == 'Completed'">Payout</td>
                            </tr>
                            <tr *ngFor="let ticket of gameDetails.tickets">
                                <td innerHTML="{{ticket.address | identity | async}}"></td>
                                <td>
                                    <span *ngIf="ticket.amount1"
                                        innerHTML="{{ticket.amount1 | amount:gameDetails.assetId | async}}"></span>
                                </td>
                                <td>
                                    <span *ngIf="ticket.amount2"
                                        innerHTML="{{ticket.amount2 | amount:gameDetails.assetId | async}}"></span>
                                </td>
                                <td *ngIf="gameDetails.storage.option3">
                                    <span *ngIf="ticket.amount3"
                                        innerHTML="{{ticket.amount3 | amount:gameDetails.assetId | async}}"></span>
                                </td>
                                <td *ngIf="gameDetails.status == 'Completed'">
                                    <span innerHTML="{{ticket.payout | amount:gameDetails.assetId | async}}"></span>
                                    <span *ngIf="ticket.payout > 0" class="ml-10 hand" data-toggle="tooltip"
                                        data-title="Winner">
                                        <i class="fas fa-medal text-success"></i>
                                    </span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="row row-eq-spacing-xl">
        <div *ngIf="!actions.loadingGame && !loadingError && gameDetails.storage.manager == app.account && gameDetails.status == 'Running'"
            class="col-xl-6">
            <div class="card h-full">
                <div class="row">
                    <div class="col-sm">
                        <h2 class="content-title text-success">
                            Finalise game
                        </h2>
                        <p class="text-muted mb-20">
                            As the manager of this game, you will be able to set the winning option and finalise the
                            game when the timer runs out.
                        </p>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-no-outer-padding">
                        <tbody>
                            <tr>
                                <td class="text-secondary">Your current profit</td>
                                <td
                                    innerHTML="{{gameDetails.storage.managerShare | amount:gameDetails.assetId | async}}">
                                </td>
                            </tr>
                            <tr>
                                <td class="text-secondary">Time left</td>
                                <td>{{gameDetails.timespanLeft}}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div *ngIf="!actions.loadingGame && !loadingError && gameDetails.storage.manager == app.account && gameDetails.status == 'Finalising'"
            class="col-xl-6">
            <div class="card h-full">
                <div class="row">
                    <div class="col-sm">
                        <h2 class="content-title text-success">
                            Finalise game
                        </h2>
                        <p *ngIf="gameDetails.storage.volume > 0" class="text-muted mb-20">
                            Now that the game timer has run out, you can finalise it by setting the winning option.
                            Afterwards, you will be able to withdraw your profits.
                        </p>
                        <p *ngIf="gameDetails.storage.volume == 0" class="text-muted mb-20">
                            Unfortunately, no one has placed bets for this game. So there is nothing to be finalised.
                        </p>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-no-outer-padding">
                        <tbody>
                            <tr>
                                <td class="text-secondary">Your profit</td>
                                <td
                                    innerHTML="{{gameDetails.storage.managerShare | amount:gameDetails.assetId | async}}">
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div *ngIf="gameDetails.storage.volume > 0">
                    <div class="form-group my-20">
                        <label class="text-secondary">Winning option</label>
                        <p class="mt-0 text-muted font-size-12">
                            Choose which option wins this game.
                        </p>
                        <div class="input-group mw-full">
                            <div class="input-group-prepend">
                                <button [ngClass]="{'btn-secondary': model.winner == 1}" (click)="changeWinner(1)"
                                    class="btn" type="button">{{gameDetails.storage.option1}}</button>
                            </div>
                            <div class="input-group-prepend">
                                <button [ngClass]="{'btn-secondary': model.winner == 2}" (click)="changeWinner(2)"
                                    class="btn" type="button">{{gameDetails.storage.option2}}</button>
                            </div>
                            <div class="input-group-prepend" *ngIf="gameDetails.storage.option3">
                                <button [ngClass]="{'btn-secondary': model.winner == 3}" (click)="changeWinner(3)"
                                    class="btn" type="button">{{gameDetails.storage.option3}}</button>
                            </div>
                        </div>
                    </div>
                    <button *ngIf="!actions.finalisingGame" class="btn btn-success mt-20 mb-0" (click)="finaliseGame()">
                        Finalise Game
                    </button>
                    <button *ngIf="actions.finalisingGame" class="btn btn-success mt-20 mb-0">
                        <i class="fas fa-cog fa-spin mx-20"></i>
                    </button>
                </div>
            </div>
        </div>
        <div *ngIf="!actions.loadingGame && !loadingError && gameDetails.storage.manager == app.account && gameDetails.status == 'Completed'"
            class="col-xl-6">
            <div class="card h-full">
                <div class="row">
                    <div class="col-sm">
                        <h2 class="content-title text-success">
                            Thank You
                        </h2>
                        <p class="text-muted mb-20">
                            Thank you for creating this game using our platform. It is now fully completed.
                        </p>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-no-outer-padding">
                        <tbody>
                            <tr>
                                <td class="text-secondary">Your profit</td>
                                <td
                                    innerHTML="{{gameDetails.storage.managerShare | amount:gameDetails.assetId | async}}">
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div>
                    <button class="btn btn-success mt-20 mb-0"
                        (click)="navigateToPage(gameDefinition.route + '/create')">
                        Create New Game
                    </button>
                </div>
            </div>
        </div>
        <div *ngIf="!actions.loadingGame && !loadingError && gameDetails.storage.manager != app.account"
            class="col-xl-6">
            <div class="card h-full">
                <div class="row">
                    <div class="col-sm">
                        <h2 class="content-title text-success">
                            Create new game
                        </h2>
                        <p class="text-muted mb-20">
                            Anyone can create a prediction game using our game engine. As the game creator, you will
                            earn a share of the prize pool. When creating the game, you will be defining the potential
                            game outcomes for the players to bet on. Games can be setup with ALGO or any other Algorand
                            ASA. At the end of the game, you are responsible for submitting the winning outcome.
                        </p>
                        <button class="btn btn-success mb-0" (click)="navigateToPage(gameDefinition.route + '/create')">
                            Create New Game
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div *ngIf="!actions.loadingGame && !loadingError && gameDetails.storage.manager == app.account && gameDetails.status == 'Running'"
            class="col-xl-6">
            <div class="card h-full">
                <div class="row">
                    <div class="col-sm">
                        <h2 class="content-title text-success">
                            Update name
                        </h2>
                        <p class="text-muted mb-20">
                            As the manager of this game you can update its name anytime before the timer runs out.
                        </p>
                    </div>
                </div>
                <hr>
                <div class="form-group my-20">
                    <label class="text-secondary">Name</label>
                    <p class="mt-0 text-muted font-size-12">
                        Just a short title to help players easily identify this prediction. Maximum 64 characters.
                    </p>
                    <input [(ngModel)]="model.name" class="form-control w-400 mw-full" type="text" maxlength="64"
                        placeholder="Name of Prediction">
                </div>
                <button *ngIf="!actions.updatingName" class="btn btn-success" (click)="updateName()">
                    Update Name
                </button>
                <button *ngIf="actions.updatingName" class="btn btn-success">
                    <i class="fas fa-cog fa-spin mx-20"></i>
                </button>
            </div>
        </div>
    </div>
    <div class="row row-eq-spacing-xl"
        *ngIf="!actions.loadingGame && !loadingError && gameDetails.storage.manager == app.account && gameDetails.status == 'Running'">
        <div class="col-xl-6">
            <div class="card h-full">
                <div class="row">
                    <div class="col-sm">
                        <h2 class="content-title text-success">
                            Update timer
                        </h2>
                        <p class="text-muted mb-20">
                            As the manager of this game you can update its timer anytime before the current timer
                            runs out.
                        </p>
                    </div>
                </div>
                <hr>
                <div class="form-group my-20">
                    <label class="text-secondary">Timer</label>
                    <p class="mt-0 text-muted font-size-12">
                        Set the end time for prediction. We will only allow ticket purchases until this time is reached.
                    </p>
                    <input [(ngModel)]="model.timer" class="form-control w-400 mw-full" type="datetime-local">
                </div>
                <button *ngIf="!actions.updatingTimer" class="btn btn-success" (click)="updateTimer()">
                    Update Timer
                </button>
                <button *ngIf="actions.updatingTimer" class="btn btn-success">
                    <i class="fas fa-cog fa-spin mx-20"></i>
                </button>
            </div>
        </div>
    </div>
</div>